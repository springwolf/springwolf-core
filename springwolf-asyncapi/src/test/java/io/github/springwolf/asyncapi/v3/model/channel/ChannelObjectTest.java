// SPDX-License-Identifier: Apache-2.0
package io.github.springwolf.asyncapi.v3.model.channel;

import io.github.springwolf.asyncapi.v3.ClasspathUtil;
import io.github.springwolf.asyncapi.v3.bindings.amqp.AMQPChannelBinding;
import io.github.springwolf.asyncapi.v3.bindings.amqp.AMQPChannelQueueProperties;
import io.github.springwolf.asyncapi.v3.bindings.amqp.AMQPChannelType;
import io.github.springwolf.asyncapi.v3.jackson.DefaultAsyncApiSerializerService;
import io.github.springwolf.asyncapi.v3.model.ExternalDocumentation;
import io.github.springwolf.asyncapi.v3.model.Tag;
import io.github.springwolf.asyncapi.v3.model.channel.message.MessageReference;
import io.github.springwolf.asyncapi.v3.model.server.ServerReference;
import org.junit.jupiter.api.Test;

import java.util.List;
import java.util.Map;

import static net.javacrumbs.jsonunit.assertj.JsonAssertions.assertThatJson;

class ChannelObjectTest {
    private static final DefaultAsyncApiSerializerService serializer = new DefaultAsyncApiSerializerService();

    @Test
    void shouldSerializeChannelObject() throws Exception {
        ChannelObject channelObject = ChannelObject.builder()
                .address("users.{userId}")
                .title("Users channel")
                .description("This channel is used to exchange messages about user events.")
                .messages(Map.of(
                        "userSignedUp",
                        MessageReference.toComponentMessage("userSignedUp"),
                        "userCompletedOrder",
                        MessageReference.toComponentMessage("userCompletedOrder")))
                .parameters(Map.of(
                        "userId",
                        ChannelParameter.builder()
                                .ref("#/components/parameters/userId")
                                .build()))
                .servers(List.of(
                        ServerReference.builder()
                                .ref("#/servers/rabbitmqInProd")
                                .build(),
                        ServerReference.builder()
                                .ref("#/servers/rabbitmqInStaging")
                                .build()))
                .bindings(Map.of(
                        "amqp",
                        AMQPChannelBinding.builder()
                                .is(AMQPChannelType.QUEUE)
                                .queue(AMQPChannelQueueProperties.builder()
                                        .exclusive(true)
                                        .build())
                                .build()))
                .tags(List.of(Tag.builder()
                        .name("user")
                        .description("User-related messages")
                        .build()))
                .externalDocs(ExternalDocumentation.builder()
                        .description("Find more info here")
                        .url("https://example.com")
                        .build())
                .build();

        String example = ClasspathUtil.readAsString("/v3/model/channel/channel.json");
        assertThatJson(serializer.toJsonString(channelObject))
                // These values are autogenerated, so we can ignore them from the test
                .whenIgnoringPaths("bindings.amqp.bindingVersion", "bindings.amqp.queue.vhost")
                .isEqualTo(example);
    }
}
